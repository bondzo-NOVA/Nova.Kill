<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/png" href="/login/static/favicon.png">
  <title>DonutFlip Login</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 4em auto;
      text-align: center;
      color: #bffcff;
    }
    .hidden { display: none; }
    .dot-label { font-weight: bold; margin-right: 0.3em; }
    .version-btn-row {
      display: flex;
      justify-content: center;
      gap: 2em;
      margin-bottom: 2em;
    }
    input {
      font-size: 1em;
      padding: 0.5em;
      width: 80%;
      color: #fff;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.10);
      outline: none;
      transition: background 0.2s, box-shadow 0.2s;
    }
    input:focus {
      background: rgba(255,255,255,0.18);
      box-shadow: 0 4px 24px 0 rgba(3,113,254,0.15);
    }
    button {
      padding: 0.5em 1em;
      font-size: 1em;
      margin: 1em;
      color: #bffcff;
    }
    .submit-btn {
      background: #0371fe;
      color: #fff;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 8px 0 rgba(3,113,254,0.10);
      transition: background 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .submit-btn:hover, .submit-btn:focus {
      background: #005ed6;
      box-shadow: 0 4px 16px 0 rgba(3,113,254,0.18);
    }
    .version-btn {
      background: none;
      border: 2px solid transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      border-radius: 10px;
      transition: border-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .version-btn.selected {
      border-color: #2196f3;
      box-shadow: 0 0 10px #2196f388;
    }
    code {
      background: #222;
      color: #bffcff;
      padding: 0.5em;
      display: block;
      margin: 1em auto;
      width: fit-content;
    }
    input::placeholder {
      color: #bffcff;
      opacity: 0.7;
    }
    .rainbow-text {
      transition: color 0.2s;
    }
    .copy-btn {
      background: #0049e3;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.4em 1.2em;
      margin-top: 0.5em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    .copy-btn:active,
    .copy-btn.copied {
      background: #022c7a;
    }
  </style>
</head>
<body>
  <canvas id="bg-canvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;"></canvas>
  
  <img src="/login/static/navbarlogo.png" alt="DonutFlip Logo" style="height:90px; margin-bottom: 0.5em; margin-top: -2em;">

  <h2 class="rainbow-text">Login to DonutFlip</h2>
  <p class="rainbow-text">What version are you on?</p>
  <div class="version-btn-row">
    <button id="javaBtn" class="version-btn" onclick="chooseVersion('java')">
      <img src="/login/static/javaedition.png" alt="Java Edition" style="height:70px;">
    </button>
    <button id="bedrockBtn" class="version-btn" onclick="chooseVersion('bedrock')">
      <img src="/login/static/bedrockedition.png" alt="Bedrock Edition" style="height:70px;">
    </button>
  </div>

  <div id="usernameSection" class="hidden">
    <p class="rainbow-text">Enter your username: (Case Sensitive)</p>
    <div>
      <span id="dotPrefix" class="dot-label rainbow-text hidden">.</span>
      <input type="text" id="usernameInput" />
    </div>
    <button onclick="submitUsername()" class="rainbow-text submit-btn">Submit</button>
  </div>

  <div id="loginStringSection" class="hidden">
    <p class="rainbow-text">To verify, do <b>/tpa</b> to the bot on DonutSMP:</p>
    <code id="loginTpaCommand" class="rainbow-text"></code>
    <button id="copyTpaButton" class="rainbow-text copy-btn">Copy</button>
    <p id="loginStatus" class="rainbow-text" style="margin-top: 1em; color: green;"></p>
  </div>

  <script>
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  if (getCookie('username')) {
    window.location.href = '/';
  }

    const colors = ["#2196f3", "#ffd700"];
    const canvas = document.getElementById("bg-canvas");
    const ctx = canvas.getContext("2d");
    let particles = [];
    let mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 };

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function randomBetween(a, b) {
      return a + Math.random() * (b - a);
    }

    function createParticles(count) {
      particles = [];
      for (let i = 0; i < count; i++) {
        particles.push({
          x: randomBetween(0, canvas.width),
          y: randomBetween(0, canvas.height),
          r: randomBetween(20, 60),
          color: colors[Math.floor(Math.random() * colors.length)],
          dx: randomBetween(-0.5, 0.5),
          dy: randomBetween(-0.5, 0.5),
          baseR: 0
        });
      }
      particles.forEach(p => p.baseR = p.r);
    }
    createParticles(30);

    canvas.addEventListener("mousemove", function(e) {
      mouse.x = e.clientX;
      mouse.y = e.clientY;
    });

    function animate() {
      ctx.fillStyle = "#111";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      for (let p of particles) {
        let dist = Math.hypot(p.x - mouse.x, p.y - mouse.y);
        if (dist < 120) {
          p.r = Math.min(p.baseR * 1.7, p.r + 1);
        } else {
          p.r = Math.max(p.baseR, p.r - 0.5);
        }
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.globalAlpha = 0.45;
        ctx.fill();
        ctx.globalAlpha = 1;
        p.x += p.dx;
        p.y += p.dy;
        if (p.x < p.r || p.x > canvas.width - p.r) p.dx *= -1;
        if (p.y < p.r || p.y > canvas.height - p.r) p.dy *= -1;
      }
      requestAnimationFrame(animate);
    }
    animate();

    let version = null;
        let username = "";

    function chooseVersion(ver) {
      version = ver;
      document.getElementById("usernameSection").classList.remove("hidden");
      document.getElementById("dotPrefix").classList.toggle("hidden", ver !== "bedrock");

      document.getElementById("javaBtn").classList.toggle("selected", ver === "java");
      document.getElementById("bedrockBtn").classList.toggle("selected", ver === "bedrock");
    }

    function handleCopyButton(btn) {
      const original = btn.textContent;
      btn.textContent = "Copied!";
      btn.classList.add("copied");
      setTimeout(() => {
        btn.textContent = original;
        btn.classList.remove("copied");
      }, 1200);
    }

    function normalizeUsername(rawUsername, isBedrock) {
      const clean = rawUsername.replace(/^\.*/, "");
      return isBedrock ? `.${clean}` : clean;
    }

    async function submitUsername() {
      const rawInput = document.getElementById("usernameInput").value.trim();
      if (!rawInput) return alert("Please enter your username.");

      username = normalizeUsername(rawInput, version === "bedrock");

      const res = await fetch("/login/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, isBedrock: version === "bedrock" })
      });
      const data = await res.json();

      const tpaCommand = `/tpa ${data.botName}`;
      document.getElementById("loginTpaCommand").textContent = tpaCommand;
      document.getElementById("copyTpaButton").onclick = (e) => {
        navigator.clipboard.writeText(tpaCommand);
        handleCopyButton(e.target);
      };

      document.getElementById("loginStringSection").classList.remove("hidden");
      checkAuthenticationLoop();
    }

    async function checkAuthenticationLoop() {
      const res = await fetch("/login/api/check-auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username }),
        credentials: "include"
      });
      const data = await res.json();

      if (data.authenticated) {
        document.getElementById("loginStatus").textContent = "âœ… Successfully logged in.";
        setTimeout(() => {
          window.location.href = "/";
        }, 1000);
      } else {
        setTimeout(checkAuthenticationLoop, 2000);
      }
    }

    function animateRainbowText() {
      const elements = Array.from(document.querySelectorAll('.rainbow-text'));
      const now = performance.now();
      const period = 6000;
      const offsetStep = 300;

      elements.forEach((el, i) => {
        const t = ((now + i * offsetStep) % period) / period;
        const hue = Math.floor(t * 360);
        el.style.color = `hsl(${hue}, 100%, 70%)`;
      });
      requestAnimationFrame(animateRainbowText);
    }
    animateRainbowText();
  </script>
</body>
</html>
